suite: test httproute
templates:
  - httproute.yaml
tests:
  - it: should create HTTPRoute when enabled
    set:
      httproute.enabled: true
    asserts:
      - isKind:
          of: HTTPRoute
      - equal:
          path: metadata.name
          value: RELEASE-NAME-learn-ruby
      - equal:
          path: metadata.labels["app.kubernetes.io/part-of"]
          value: learn-ruby

  - it: should not create HTTPRoute when disabled
    set:
      httproute.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should include httproute annotations
    set:
      httproute.enabled: true
    asserts:
      - equal:
          path: metadata.annotations["networking.x-k8s.io/route-shard"]
          value: example
      - equal:
          path: metadata.annotations["cert-manager.io/cluster-issuer"]
          value: letsencrypt-staging
      - equal:
          path: metadata.annotations["external-dns.alpha.kubernetes.io/target"]
          value: enter.example.com

  - it: should include custom httproute labels
    set:
      httproute.enabled: true
    asserts:
      - equal:
          path: metadata.labels["x-use-cloudflare-solver"]
          value: "true"

  - it: should configure gateway reference
    set:
      httproute.enabled: true
    asserts:
      - contains:
          path: spec.parentRefs
          content:
            name: external
            namespace: kube-system
            sectionName: https

  - it: should configure hostnames
    set:
      httproute.enabled: true
    asserts:
      - contains:
          path: spec.hostnames
          content: example.local

  - it: should configure backend service
    set:
      httproute.enabled: true
    asserts:
      - equal:
          path: spec.rules[0].backendRefs[0].port
          value: 4567
